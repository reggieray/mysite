trigger:
  - master

pool:
  vmImage: "ubuntu-latest"

variables:
  configuration: debug
  platform: x64

steps:
  - task: DotNetCoreInstaller@0
    displayName: Install .NET Core SDK
    name: install_dotnetcore_sdk
    enabled: true
    inputs:
      packageType: "sdk"
      version: "2.2.110"

  - script: |
      sudo apt-get update
      wget http://security.ubuntu.com/ubuntu/pool/main/o/openssl1.1/libssl1.1_1.1.1f-1ubuntu2.22_amd64.deb
      sudo dpkg -i libssl1.1_1.1.1f-1ubuntu2.22_amd64.deb || true
    displayName: "Install libssl1.1"

  - script: dotnet tool install -g Wyam.Tool
    displayName: Install Wyam

  - script: wyam
    displayName: Build Site

  - task: ArchiveFiles@2
    displayName: Zip Site
    inputs:
      rootFolderOrFile: "$(Agent.BuildDirectory)/s/output"
      includeRootFolder: true
      archiveType: "zip"
      archiveFile: "$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip"
      replaceExistingArchive: true

  - script: >-
      curl
      -H 'Authorization: Bearer $(netlifyAccessToken)' 
      -H 'Content-Type: application/zip'
      --data-binary '@$(Build.BuildId).zip'
      https://api.netlify.com/api/v1/sites/$(netlifySiteId)/deploys
    workingDirectory: "$(Build.ArtifactStagingDirectory)"
    displayName: "Upload to Netlify"
